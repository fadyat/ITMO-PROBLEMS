# Работа со средствами мониторинга и диагностики в Windows

## Цель работы

Ознакомиться со встроенными средствами технического мониторинга, назначением и принципами работы Prefomance Monitor.
Получить навыки сбора и анализа данных, позволяющих оценивать производительность системы. Получить практические навыки
поиска "узких мест" в производительности системы. Получить дополнительные навыки по управлению Windows Server,
управлению процессами и журналами работы.

Необходимо:

- Установленная на компьютере среда виртуализации ORACLE Virtual Box
- Образы виртуальных жёстких дисков операционных систем Windows Server 2012/2016.
- Доступ к Microsoft Evaluation Center (https://www.microsoft.com/ru-ru/evalcenter)

## Краткие теоретические сведения

Одной из важнейших составляющих обеспечения функциональности системы является ее мониторинг. Современные ОС содержат
средства для осуществления технического мониторинга.

К целям технического мониторинга относятся:

- наблюдение за текущими параметрами системы;
- сбор статистики для ретроспективного анализа, построения профилей загрузки системы, отладки и настройки приложений,
  прогностического анализа;
- автоматизации реакции системы на определенные ее состояния.

В системе ОС Windows содержится компонент Performance Monitor, реализующий технический мониторинг.

Performance Monitor позволяет создавать:

- Группу Сборщиков Данных – набор единообразно управляемых журналов сбора данных. В ней создавать:
- Счетчик Производительности - журнал, в который с определенной периодичностью заносятся значения Счетчиков – атрибутов
  программных объектов, представляющих или аппаратные или программные подсистемы (Процессор, UDP, Файл Подкачки и т.п.).
- Сборщик данных отслеживания событий - куда заносятся все события, происходящие в подсистеме, которая выбрана в виде
  провайдера при создании сборщика.
- Оповещение счетчика производительности – специального журнала, позволяющего автоматически реагировать на определённое
  состояние счетчика.

В Performance Monitor содержит раздел Отчетов, через который доступны обработанные сводные данные журналов.

Если журнал Счетчик Производительности ведется в бинарном формате, то конвертировать его в текстовый формат позволяет
утилита `relog.exe`.

Для конвертации журнала Сборщик данных отслеживания событий используется утилита `tracerpt.exe`.

Как любая зрелая операционная система Windows содержит подсистему видения системных журналов. Доступны системные
журналы (Приложения, Безопасность, Система, Установка, Перенаправленные события) и журналы приложений и служб.

Для работы с журналами служат оснастка Просмотр событий (eventvwr.msc), консольная утилита Wevtutil и PowerShell.

Windows содержит механизм запуска процессов по расписанию или событиям - Планировщик Заданий. Для работы с ним служат
консоль taskschd.msc, утилиты schtasks.exe и at (устарела), а также PowerShell.

## Порядок выполнения работы:

### Часть 1. Работа с процессами. Разработка скриптов.

- Напишите скрипт, который создает Журнал Работы с именем «ProcessMonitoringLog». Если журнал существует, то выводится
  сообщение об этом.
- Напишите скрипт на PowerShell, который:
- при запуске выводит список запущенных процессов (PID, Имя процесса, Путь к исполняемому файлу, Пользователь процесса,
  Утилизация CPU, Занимаемая память, Время Получения данных).
- Записывает эти данные в CSV файл.
- При успешном сохранении данных пишет в журнал ProcessMonitoringLog сообщение об успехе, при ошибках сохранения –
  сообщение об ошибке.

### Часть 2. Планирование периодического выполнения.

- С помощью PowerShell добавьте автоматический запуск скрипта из Части 1. п.2 в планировщике заданий Windows (Task
  Scheduler), так чтобы, но запускался каждые 3 минуты, даже тогда, когда питание идет не от батареи или ИБП.
- Убедитесь в работоспособности решения.

### Часть 3. Работа с журналом событий.

- Ознакомитесь с журналом событий.
- Создайте настраиваемое представление журнала, позволяющее увидеть все неудачные попытки входа в ОС под именем
  Администратора.

С помощью PowerShell напишите скрипт, который выводит в текстовый файл:

- время последних 10 включений компьютера,
- время 5 последних установок пакетов обновлений с указанием названий обновлений (например KB1299393),
- количество ошибок и количество предупреждений за последние 24 часа.

### Часть 4. Сбор и анализ данных

- Создать в программе Performance Monitor Группу Сборщиков Данных, которая будет содержать:

    - Счетчик Производительности записи которого позволят сравнить загрузку аппаратного обеспечения платформы.
      Счетчики для этого следует выбрать самостоятельно, но они должны отражать использование памяти, дисковой
      подсистемы,
      процессора и сети.
    - Периодичность журнала установить в 5 секунд.
    - Сборщик данных отслеживания событий, фиксирующий события ядра Windows.

- С помощью Группы Сборщиков Данных сравните загрузку системы в двух разных ситуациях. Это может быть загрузка при
  использовании разных приложений одного типа (2 антивируса, 2 браузера, 2 СУБД, 2 кодека и т. п.), наборы разных
  программ (MS Word + MS Excel и MS Excel + MS Access и т.п.) или одно и то же приложение при разной его
  конфигурации.
- С помощью механизма отчетов дайте первичный анализ загрузки в обоих случаях.
- С помощью электронных таблиц или других средств анализа данных представите данные о загрузке в виде графиков.

### Часть 5. Автоматизация реакции системы на ее состояние

- Добавьте в виртуальную машину еще один жесткий диск объемом 200 Мб. Включите виртуальную машину и создайте на новом
  диске раздел.
- Создайте скрипт, который постепенно заполняет новый логический диск файлами размером до 1 Мб.
- Создайте скрипт, очищающий новый диск.
- В Performance Monitor создайте новую Группу Сборщиков Данных с Оповещением счетчика производительности, который,
  срабатывает в случае, если осталось менее 20% свободного места на новом разделе и выводящее предупреждение в журнал
  событий и запускающее сприт из п.3. Разработчики Performance Monitor предполагают, что нужно в Планировщике заданий
  создать задание, выполняющее скрипт из
  п. 3 и указать имя этого задания в настройках Сборщика данных отслеживания событий.
- Проверьте срабатывание оповещений. Вероятно, вы обнаружите неожиданное поведение системы. Попробуйте выяснить причину,
  заменяя используемые счетчики.

### Артефакты:

- Скрипты из Части 1
- Скрипты из Части 2
- Параметры Представления из Части 3, п.2
- Скрипт из части 3. п. 3
- Материалы и результаты анализа из Части 4 п. 3-4
- Скрипты из части 5.

### Вопросы:

- В чем назначение каждого из разделов журнала событий?
- Зачем нужен раздел Перенаправленные события?
- Где находится журналы событий Windows в виде файлов?
- Как с помощью графической оснастки журнала событий установить по известному VID коду, когда было подключено и
  настроено устройство?
- Почему были выбраны конкретные счетчики в Части 4 п.1? Обоснуйте выбор.
- Как получить на консоль подробные параметры запланированного задания с помощью утилиты schtasks.exe? Проиллюстрируйте
  ответ на примере задания из части 5.
- Опишите ваши выводы по пункту 5. Части 5.



